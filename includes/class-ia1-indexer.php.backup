<?php
/**
 * Gestion de l'indexation et de la recherche
 *
 * @package IA1
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

class IA1_Indexer {
    
    private $table_name;
    
    public function __construct() {
        global $wpdb;
        $this->table_name = $wpdb->prefix . 'ia1_index';
    }
    
    /**
     * Réindexe tout le contenu
     */
    public function reindex_all() {
        global $wpdb;
        
        $result = array(
            'indexed' => 0,
            'errors' => 0
        );
        
        // Vider la table
        $wpdb->query( "TRUNCATE TABLE {$this->table_name}" );
        
        // Récupérer TOUS les types de contenu publics
        $post_types = get_post_types( array( 'public' => true ), 'names' );
        
        // Récupérer tous les posts de tous types publics
        $args = array(
            'post_type' => $post_types,
            'post_status' => 'publish',
            'posts_per_page' => -1,
            'orderby' => 'date',
            'order' => 'DESC'
        );
        
        $query = new WP_Query( $args );
        
        if ( $query->have_posts() ) {
            while ( $query->have_posts() ) {
                $query->the_post();
                
                try {
                    $this->index_post( get_post() );
                    $result['indexed']++;
                } catch ( Exception $e ) {
                    $result['errors']++;
                }
            }
        }
        
        wp_reset_postdata();
        
        return $result;
    }
    
    /**
     * Indexe un post
     */
    public function index_post( $post ) {
        global $wpdb;
        
        // Nettoyer le contenu
        $content = wp_strip_all_tags( $post->post_content );
        $content = preg_replace( '/\s+/', ' ', $content );
        $content = trim( $content );
        
        // Ne pas indexer si le contenu est trop court
        if ( strlen( $content ) < 50 ) {
            return false;
        }
        
        // Insérer ou mettre à jour
        $wpdb->replace(
            $this->table_name,
            array(
                'post_id' => $post->ID,
                'post_type' => $post->post_type,
                'title' => $post->post_title,
                'content' => $content,
                'url' => get_permalink( $post->ID ),
                'indexed_at' => current_time( 'mysql' )
            ),
            array( '%d', '%s', '%s', '%s', '%s', '%s' )
        );
        
        return true;
    }
    
    /**
     * Recherche dans l'index
     */
    public function search( $query, $limit = null ) {
        global $wpdb;
        
        if ( $limit === null ) {
            $limit = (int) get_option( 'ia1_max_contexts', 5 );
        }
        
        // Nettoyer la requête
        $query = sanitize_text_field( $query );
        $query_words = explode( ' ', $query );
        
        // Construire la clause WHERE pour recherche full-text
        $where_clauses = array();
        foreach ( $query_words as $word ) {
            if ( strlen( $word ) > 2 ) {
                $word = $wpdb->esc_like( $word );
                $where_clauses[] = "(title LIKE '%{$word}%' OR content LIKE '%{$word}%')";
            }
        }
        
        if ( empty( $where_clauses ) ) {
            return array();
        }
        
        $where = implode( ' OR ', $where_clauses );
        
        // Requête SQL
        $sql = $wpdb->prepare(
            "SELECT * FROM {$this->table_name} 
             WHERE {$where}
             ORDER BY 
                CASE 
                    WHEN title LIKE %s THEN 1
                    WHEN content LIKE %s THEN 2
                    ELSE 3
                END,
                indexed_at DESC
             LIMIT %d",
            '%' . $wpdb->esc_like( $query ) . '%',
            '%' . $wpdb->esc_like( $query ) . '%',
            $limit
        );
        
        $results = $wpdb->get_results( $sql, ARRAY_A );
        
        // Extraire des passages pertinents
        foreach ( $results as &$result ) {
            $result['excerpt'] = $this->extract_relevant_excerpt( $result['content'], $query );
        }
        
        return $results;
    }
    
    /**
     * Extrait un passage pertinent du contenu
     */
    private function extract_relevant_excerpt( $content, $query, $length = 300 ) {
        $query_lower = strtolower( $query );
        $content_lower = strtolower( $content );
        
        // Trouver la position de la requête
        $pos = strpos( $content_lower, $query_lower );
        
        if ( $pos === false ) {
            // Si pas de match exact, prendre le début
            return substr( $content, 0, $length ) . '...';
        }
        
        // Extraire autour de la position trouvée
        $start = max( 0, $pos - 100 );
        $excerpt = substr( $content, $start, $length );
        
        // Nettoyer
        if ( $start > 0 ) {
            $excerpt = '...' . $excerpt;
        }
        if ( strlen( $content ) > $start + $length ) {
            $excerpt .= '...';
        }
        
        return $excerpt;
    }
    
    /**
     * Compte le nombre de documents indexés
     */
    public function get_indexed_count() {
        global $wpdb;
        return (int) $wpdb->get_var( "SELECT COUNT(*) FROM {$this->table_name}" );
    }
    
    /**
     * Supprime un post de l'index
     */
    public function delete_post( $post_id ) {
        global $wpdb;
        return $wpdb->delete(
            $this->table_name,
            array( 'post_id' => $post_id ),
            array( '%d' )
        );
    }
}